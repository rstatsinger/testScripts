
echo "testing build..."
# project name

BUILDNUM=$1

PROJNAME=$2

PROJECT=$PROJNAME${BUILDNUM}

# violation string or substring
VIOLSTRING=$3

# ShiftLeft demo lab  org ID
SHIFTLEFT_ORG_ID=8e348e46-3174-46e6-8ca9-6fed63e40cea

# user bearer token

TOKEN=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IlJFTkZNak5DUVVReFF6aERPRGcwT1VFd05EZzJSakUwT0RSRVFVTTFORFV5UlRVeE9VSXpPUSJ9.eyJuaWNrbmFtZSI6InJzdGF0c2luZ2VyIiwibmFtZSI6InJzdGF0c2luZ2VyQHNoaWZ0bGVmdC5pbyIsInBpY3R1cmUiOiJodHRwczovL3MuZ3JhdmF0YXIuY29tL2F2YXRhci83M2E5NjkwY2FhMGU0YmU1MzFiMmI0ZjQ4ZWZhZjAzMD9zPTQ4MCZyPXBnJmQ9aHR0cHMlM0ElMkYlMkZjZG4uYXV0aDAuY29tJTJGYXZhdGFycyUyRnJzLnBuZyIsInVwZGF0ZWRfYXQiOiIyMDE4LTEwLTE4VDEzOjUxOjI4LjA4OVoiLCJlbWFpbCI6InJzdGF0c2luZ2VyQHNoaWZ0bGVmdC5pbyIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJpc3MiOiJodHRwczovL3NoaWZ0bGVmdC5hdXRoMC5jb20vIiwic3ViIjoiYXV0aDB8NWE1N2ZjYmRhOTg4MTIyOGEwM2VhNTFjIiwiYXVkIjoiVzcwdEszQTB4bHlnSFp2a1ptUUwxTnU2OTFmZEpqMFgiLCJpYXQiOjE1Mzk4NzA2ODgsImV4cCI6MTU0MDQ3NTQ4OH0.AvKd80sRxOZXooOcUZ6n38jO2hiYVdktLEZPa2TeYHevMSl9PwLrbsCFiA6WDUypfZdqLXXMtA5BZQwZShENbeAl_DOgr83xmVUtrA4RURYC8A9pZ-jhs0CWeyj5_RRKUyk8kNlbJcbHpaw190bqS-_NNWS7iATmyEeStHsC4sv_SCI0oOtWStD8pmjqAUSFp6VlPFigfzFwk-u32bBF4xMH6p45BtVGvOuTuH4HQHiLbt3ETb9XapcbUzi1L_ezsfpBJdFjgDvVpCy2_2BlRySUBfDP2oCEI9Fo90DK0QR_UFbPl3XjPBUPUQbpZO9xrnKIG7GProNi2rwGLUOBcw

numViols=`curl -s "https://www.shiftleft.io/api/v2/organizations/$SHIFTLEFT_ORG_ID/projects/$PROJECT/metrics" -H "authorization: Bearer $TOKEN" -H "content-type: application/json" --data-binary "{\"context\":{\"projectSpId\":\"sl/$SHIFTLEFT_ORG_ID/$PROJECT\"},\"queries\":[{\"violationsAll\":{\"projectSpId\":\"sl/$SHIFTLEFT_ORG_ID/$PROJECT\"}}]}" | grep -i -o $VIOLSTRING | wc -l`

# | jq ".responses[0].violationsAll.violations | map(select(.count > 0)) | map(.name)" 

if [ $numViols -gt 0 ]; then
        echo -n "nonzero number of vulnerabilities: "
        echo $numViols
        exit 0;
fi
